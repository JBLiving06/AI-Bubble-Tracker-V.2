<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Bubble Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .gauge-glow { box-shadow: 0 0 30px rgba(0,0,0,0.3); }
    @keyframes pulse-slow { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .animate-pulse-slow { animation: pulse-slow 2s ease-in-out infinite; }
    .prose { line-height: 1.7; }
    .no-data { opacity: 0.4; border-style: dashed !important; }
    .context-only { opacity: 0.7; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-white">
  <div id="app" class="max-w-6xl mx-auto p-6"></div>

  <script>
    const PROXY = 'https://bubble-tracker-api.jeff-c6c.workers.dev';

    function contributesToAssessment(data) {
      if (!data || data.value === null || data.value === undefined) return false;
      return data.quality === 'LIVE' || data.quality === 'LAGGED';
    }

    const GAUGES = [
      { key: 'capex-revenue', name: 'CapEx-to-Revenue', category: 'Infrastructure', safe: 0.30, warn: 0.50, unit: 'ratio',
        meaning: 'Measures how aggressively Big Tech invests in AI infrastructure relative to earnings.',
        calculation: 'Sum of quarterly CapEx for MSFT, GOOGL, META, AMZN divided by combined revenue.',
        whyItMatters: 'Dot-com bubble featured infrastructure built ahead of demand.',
        thresholds: 'Below 0.30 = normal. 0.30-0.50 = aggressive. Above 0.50 = potentially unsustainable.' },
      { key: 'valuation', name: 'Valuation Heat', category: 'Valuation', safe: 22, warn: 30, unit: 'P/E',
        meaning: 'How many years of current earnings you pay for the market.',
        calculation: 'S&P 500 price divided by trailing 12-month earnings.',
        whyItMatters: 'P/E above 25-30 has preceded major corrections.',
        thresholds: 'Below 22 = reasonable. 22-30 = elevated. Above 30 = historically unsustainable.' },
      { key: 'market-concentration', name: 'Market Concentration', category: 'Market Structure', safe: 28, warn: 35, unit: '%',
        meaning: 'Shows how much market gains depend on a few mega-caps.',
        calculation: 'Top 10 market caps divided by S&P 500 total (calculated as index price √ó divisor).',
        whyItMatters: 'Narrow leadership preceded dot-com crash.',
        thresholds: 'Below 28% = healthy. Above 35% = extreme concentration.' },
      { key: 'debt-leverage', name: 'Corporate Leverage', category: 'Financial', safe: 0.4, warn: 0.6, unit: 'ratio',
        meaning: 'Borrowing relative to ownership stake for AI infrastructure builders.',
        calculation: 'Total debt / total equity for MSFT, GOOGL, META, NVDA, AMZN, ORCL (quarterly data).',
        whyItMatters: 'Leverage amplifies downturns. Debt-heavy builders crash hardest if bubble bursts.',
        thresholds: 'Below 0.4 = conservative. Above 0.6 = elevated risk.' },
      { key: 'volatility', name: 'Complacency (VIX)', category: 'Sentiment', safe: 20, warn: 14, unit: 'VIX', inverted: true,
        meaning: 'Low VIX = investors expect calm. High = fear.',
        calculation: 'CBOE Volatility Index from market data.',
        whyItMatters: 'Markets most vulnerable when fear is absent.',
        thresholds: 'Above 20 = healthy caution. Below 14 = excessive complacency.' },
      { key: 'credit-spread', name: 'Credit Spreads', category: 'Risk Appetite', safe: 4.5, warn: 3, unit: '%', inverted: true,
        meaning: 'Extra yield demanded for risky bonds vs Treasuries.',
        calculation: 'ICE BofA US High Yield spread from FRED.',
        whyItMatters: 'Pre-2008 spreads were extremely tight.',
        thresholds: 'Above 4.5% = appropriate. Below 3% = ignoring risk.' },
      { key: 'app-maturity', name: 'AI App Maturity', category: 'Adoption', safe: 60, warn: 40, unit: 'score', inverted: true,
        meaning: 'Score 0-100. Low = mostly pilots. High = production with ROI.',
        calculation: 'Claude AI analysis of earnings call language. DOES NOT DRIVE ASSESSMENT.',
        whyItMatters: 'If AI infra exceeds real usage, bubble risk rises.',
        thresholds: 'Above 60 = mature. Below 40 = infrastructure ahead of applications.' },
      { key: 'mag7-breadth', name: 'Mag 7 Dominance', category: 'Market Structure', safe: 25, warn: 30, unit: '%',
        meaning: 'Magnificent 7 share of market performance.',
        calculation: 'Calculated from individual returns. NOTE: Uses assumptions.',
        whyItMatters: 'Narrow leadership = fragile market.',
        thresholds: 'Below 25% = broad participation. Above 30% = extreme dependence.' },
    ];

    let gaugeData = {};
    let isLoading = true;
    let lastUpdated = null;
    let debateEssays = null;
    let isGeneratingDebate = false;
    let selectedGauge = null;
    let isAnalyzingMaturity = false;
    let maturityAnalysis = null;

    function getRiskLevel(value, gauge) {
      if (value === null || value === undefined) return null;
      if (gauge.inverted) {
        if (value >= gauge.safe) return 'safe';
        if (value >= gauge.warn) return 'warning';
        return 'danger';
      } else {
        if (value <= gauge.safe) return 'safe';
        if (value <= gauge.warn) return 'warning';
        return 'danger';
      }
    }

    function getOverallStatus(counts, totalDecisionGrade) {
      if (totalDecisionGrade < 3) {
        return { level: 'INSUFFICIENT DATA', color: '#6b7280', action: `Only ${totalDecisionGrade} decision-grade gauges. Need at least 3.` };
      }
      if (counts.danger >= 4) return { level: 'BUBBLE TERRITORY', color: '#ef4444', action: 'Multiple critical indicators. Historical parallels: dot-com 2000, housing 2007.' };
      if (counts.danger >= 2) return { level: 'OVERHEATING', color: '#f97316', action: 'Several warning signs. Correction probability elevated.' };
      if (counts.danger >= 1 || counts.warning >= 4) return { level: 'CAUTION', color: '#f59e0b', action: 'Early warning signs present. Increased vigilance warranted.' };
      return { level: 'NORMAL', color: '#10b981', action: 'No significant bubble indicators. Standard market conditions.' };
    }

    // Simple fetch without AbortSignal to avoid browser compatibility issues
    async function fetchJSON(url) {
      try {
        const resp = await fetch(url);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        return resp.json();
      } catch (e) {
        console.error('Fetch error for', url, e);
        throw e;
      }
    }

    async function fetchAllGaugeData() {
      const results = {};

      // 1. CapEx-to-Revenue (DECISION GRADE)
      console.log('Fetching CapEx-to-Revenue...');
      try {
        let totalCapex = 0, totalRevenue = 0, successCount = 0;
        for (const sym of ['MSFT', 'GOOGL', 'META', 'AMZN']) {
          try {
            const cfUrl = `${PROXY}/fmp/cashflow?symbol=${sym}`;
            const incUrl = `${PROXY}/fmp/income?symbol=${sym}`;
            console.log('Fetching', cfUrl);
            const cf = await fetchJSON(cfUrl);
            console.log('Fetching', incUrl);
            const inc = await fetchJSON(incUrl);
            console.log(`${sym} capex:`, cf?.[0]?.capitalExpenditure, 'revenue:', inc?.[0]?.revenue);
            if (cf?.[0] && inc?.[0]) {
              totalCapex += Math.abs(cf[0].capitalExpenditure || 0);
              totalRevenue += inc[0].revenue || 0;
              successCount++;
            }
          } catch (e) { 
            console.log(`CapEx failed for ${sym}:`, e.message); 
          }
        }
        console.log('CapEx totals:', totalCapex, totalRevenue, successCount);
        if (successCount >= 2 && totalRevenue > 0) {
          results['capex-revenue'] = { value: totalCapex / totalRevenue, source: `FMP (${successCount}/4 companies)`, quality: 'LIVE' };
        } else {
          results['capex-revenue'] = { value: null, source: 'API failed', quality: 'NO_DATA' };
        }
      } catch (e) {
        console.error('CapEx error:', e);
        results['capex-revenue'] = { value: null, source: 'API failed', quality: 'NO_DATA' };
      }

      // 2. S&P P/E (Valuation Heat) using EPS divisor method
      console.log('Fetching Valuation (P/E)...');
      try {
        // Get live S&P 500 price
        const spUrl = `${PROXY}/fmp/index?symbol=%5EGSPC`;
        const spData = await fetchJSON(spUrl);
        const spPrice = spData?.[0]?.price;
        
        if (spPrice) {
          // S&P 500 TTM EPS updates quarterly. Current estimate ~$230 (Q3 2024)
          // This is published by S&P and changes slowly relative to price
          const SP500_EPS = 230;
          const pe = spPrice / SP500_EPS;
          
          console.log(`P/E calculated: ${spPrice} / ${SP500_EPS} = ${pe.toFixed(2)}`);
          
          results['valuation'] = { 
            value: pe, 
            source: 'Calc (Price / EPS)', 
            quality: 'LAGGED',
            note: `S&P ${spPrice.toFixed(0)} / TTM EPS $${SP500_EPS} (quarterly update)`
          };
        } else {
          throw new Error('Could not fetch S&P 500 price');
        }
      } catch (e) {
        console.error('Valuation error:', e);
        results['valuation'] = { value: null, source: 'API failed', quality: 'NO_DATA' };
      }

      // 3. Market Concentration (now using dynamic S&P 500 total via divisor method)
      console.log('Fetching Market Concentration...');
      try {
        const top10 = ['AAPL', 'MSFT', 'NVDA', 'AMZN', 'GOOGL', 'META', 'TSLA', 'BRK-B', 'UNH', 'JPM'];
        let top10Cap = 0, successCount = 0;
        for (const sym of top10) {
          try {
            const url = `${PROXY}/fmp/profile?symbol=${sym}`;
            console.log('Fetching', url);
            const q = await fetchJSON(url);
            console.log(`${sym} marketCap:`, q?.[0]?.marketCap);
            if (q?.[0]?.marketCap) {
              top10Cap += q[0].marketCap;
              successCount++;
            }
          } catch (e) { 
            console.log(`Cap failed for ${sym}:`, e.message); 
          }
        }
        console.log('Top10 totals:', top10Cap, successCount);
        
        // Fetch S&P 500 price and calculate total market cap using divisor method
        let spTotalCap = 58e12; // Fallback if API fails
        let spSource = 'Est. total';
        try {
          const spUrl = `${PROXY}/fmp/index?symbol=%5EGSPC`;
          const spData = await fetchJSON(spUrl);
          if (spData?.[0]?.price) {
            // S&P 500 Price √ó Divisor (~8.4 billion) = Total Market Cap
            const SP500_DIVISOR = 8.4e9;
            spTotalCap = spData[0].price * SP500_DIVISOR;
            spSource = `Calc (${spData[0].price.toFixed(0)} √ó 8.4B)`;
            console.log(`Dynamic S&P Cap: ${(spTotalCap/1e12).toFixed(2)}T based on price ${spData[0].price}`);
          }
        } catch (e) {
          console.log('Failed to fetch SP500 price, using fallback');
        }
        
        if (successCount >= 7 && top10Cap > 0) {
          const concentration = (top10Cap / spTotalCap) * 100;
          results['market-concentration'] = { 
            value: Math.min(concentration, 50), 
            source: `FMP (${successCount}/10) / ${spSource}`, 
            quality: 'LIVE',
            note: 'Top 10 market caps / (S&P price √ó divisor)'
          };
        } else {
          results['market-concentration'] = { value: null, source: 'API failed', quality: 'NO_DATA' };
        }
      } catch (e) {
        console.error('Concentration error:', e);
        results['market-concentration'] = { value: null, source: 'API failed', quality: 'NO_DATA' };
      }

      // 4. Corporate Leverage (DECISION GRADE)
      console.log('Fetching Corporate Leverage...');
      try {
        // EXPANDED LIST: Added AMZN (critical for infra debt) and ORCL
        // These are the "builders" - companies with debt-heavy infrastructure spending
        // Excludes AAPL (their debt is for buybacks, not AI risk)
        const builders = ['MSFT', 'GOOGL', 'META', 'NVDA', 'AMZN', 'ORCL'];
        
        let totalDebt = 0, totalEquity = 0, successCount = 0;
        
        for (const sym of builders) {
          try {
            // The balance endpoint already returns quarterly by default
            const url = `${PROXY}/fmp/balance?symbol=${sym}`;
            console.log('Fetching', url);
            const bs = await fetchJSON(url);
            const quarter = bs?.[0]; // Most recent quarter
            
            console.log(`${sym} Debt:`, quarter?.totalDebt, 'Equity:', quarter?.totalStockholdersEquity);
            
            if (quarter) {
              totalDebt += quarter.totalDebt || 0;
              totalEquity += quarter.totalStockholdersEquity || 0;
              successCount++;
            }
          } catch (e) { 
            console.log(`Balance failed for ${sym}:`, e.message); 
          }
        }
        
        console.log('Leverage totals:', totalDebt, totalEquity, successCount);
        
        // Need at least 3 companies for valid sector trend
        if (successCount >= 3 && totalEquity > 0) {
          const ratio = totalDebt / totalEquity;
          results['debt-leverage'] = { 
            value: ratio, 
            source: `FMP (${successCount}/${builders.length} Builders)`, 
            quality: 'LIVE',
            note: `Includes MSFT, GOOGL, META, NVDA, AMZN, ORCL (Quarterly)`
          };
        } else {
          results['debt-leverage'] = { value: null, source: 'API failed', quality: 'NO_DATA' };
        }
      } catch (e) {
        console.error('Leverage error:', e);
        results['debt-leverage'] = { value: null, source: 'API failed', quality: 'NO_DATA' };
      }

      // 5. VIX (DECISION GRADE)
      console.log('Fetching VIX...');
      try {
        const url = `${PROXY}/fmp/index?symbol=%5EVIX`;
        console.log('Fetching', url);
        const vix = await fetchJSON(url);
        console.log('VIX data:', vix);
        if (vix?.[0]?.price && vix[0].price > 0) {
          results['volatility'] = { value: vix[0].price, source: 'FMP VIX', quality: 'LIVE' };
        } else {
          results['volatility'] = { value: null, source: 'VIX not available', quality: 'NO_DATA' };
        }
      } catch (e) {
        console.error('VIX error:', e);
        results['volatility'] = { value: null, source: 'API failed', quality: 'NO_DATA' };
      }

      // 6. Credit Spreads (DECISION GRADE)
      console.log('Fetching Credit Spreads...');
      try {
        const url = `${PROXY}/fred/BAMLH0A0HYM2`;
        console.log('Fetching', url);
        const spread = await fetchJSON(url);
        console.log('Spread data:', spread);
        if (spread?.observations?.[0]?.value && spread.observations[0].value !== '.') {
          results['credit-spread'] = { value: parseFloat(spread.observations[0].value), source: 'FRED', quality: 'LIVE' };
        } else {
          results['credit-spread'] = { value: null, source: 'No FRED data', quality: 'NO_DATA' };
        }
      } catch (e) {
        console.error('Spread error:', e);
        results['credit-spread'] = { value: null, source: 'API failed', quality: 'NO_DATA' };
      }

      // 7. AI App Maturity (AI_ANALYZED - context only)
      if (maturityAnalysis && maturityAnalysis.score) {
        results['app-maturity'] = { 
          value: maturityAnalysis.score, 
          source: `Claude (${maturityAnalysis.assessment_date})`, 
          quality: 'AI_ANALYZED',
          reasoning: maturityAnalysis.reasoning,
          signals: maturityAnalysis.key_signals,
          note: 'AI estimate - does not affect assessment'
        };
      } else {
        results['app-maturity'] = { value: null, source: 'Click "Analyze AI Maturity"', quality: 'AWAITING_ANALYSIS' };
      }

      // 8. Mag 7 Dominance (APPROXIMATE - context only)
      console.log('Fetching Mag7...');
      try {
        const mag7 = ['AAPL', 'MSFT', 'NVDA', 'AMZN', 'GOOGL', 'META', 'TSLA'];
        let totalReturn = 0, successCount = 0;
        
        for (const sym of mag7) {
          try {
            const url = `${PROXY}/fmp/profile?symbol=${sym}`;
            const q = await fetchJSON(url);
            console.log(`${sym} changePercentage:`, q?.[0]?.changePercentage);
            if (q?.[0]?.changePercentage !== undefined) {
              totalReturn += q[0].changePercentage;
              successCount++;
            }
          } catch (e) { 
            console.log(`Mag7 failed for ${sym}:`, e.message); 
          }
        }
        
        console.log('Mag7 totals:', totalReturn, successCount);
        if (successCount >= 5) {
          const avgReturn = totalReturn / successCount;
          const dominanceProxy = Math.min(Math.max(25 + avgReturn * 0.5, 15), 50);
          results['mag7-breadth'] = { 
            value: dominanceProxy, 
            source: `FMP (${successCount}/7) - proxy calc`, 
            quality: 'APPROXIMATE',
            note: 'Calculated proxy, not actual index contribution'
          };
        } else {
          results['mag7-breadth'] = { value: null, source: 'API failed', quality: 'NO_DATA' };
        }
      } catch (e) {
        console.error('Mag7 error:', e);
        results['mag7-breadth'] = { value: null, source: 'API failed', quality: 'NO_DATA' };
      }

      console.log('Final results:', results);
      return results;
    }

    async function analyzeMaturity() {
      isAnalyzingMaturity = true;
      render();
      
      try {
        const resp = await fetch(`${PROXY}/analyze-maturity`, { method: 'POST' });
        const data = await resp.json();
        if (data.score && !data.error) {
          maturityAnalysis = data;
          gaugeData['app-maturity'] = {
            value: data.score,
            source: `Claude (${data.assessment_date})`,
            quality: 'AI_ANALYZED',
            reasoning: data.reasoning,
            signals: data.key_signals,
            note: 'AI estimate - does not affect assessment'
          };
        }
      } catch (e) {
        console.error('Maturity analysis failed:', e);
      }
      
      isAnalyzingMaturity = false;
      render();
    }

    async function fetchAllData() {
      isLoading = true;
      render();
      try {
        gaugeData = await fetchAllGaugeData();
        lastUpdated = new Date();
      } catch (e) {
        console.error('Fetch error:', e);
      }
      isLoading = false;
      render();
    }

    async function generateDebate() {
      isGeneratingDebate = true;
      render();

      const decisionGauges = GAUGES.filter(g => contributesToAssessment(gaugeData[g.key]));
      const gaugeContext = decisionGauges.map(g => {
        const d = gaugeData[g.key];
        const level = getRiskLevel(d.value, g);
        return `- ${g.name}: ${formatValue(d.value, g)} [${level.toUpperCase()}] (${d.quality})`;
      }).join('\n');

      const contextGauges = GAUGES.filter(g => {
        const d = gaugeData[g.key];
        return d?.value !== null && !contributesToAssessment(d);
      });
      const contextText = contextGauges.map(g => {
        const d = gaugeData[g.key];
        return `- ${g.name}: ${formatValue(d.value, g)} (${d.quality} - context only)`;
      }).join('\n');

      const counts = { safe: 0, warning: 0, danger: 0 };
      decisionGauges.forEach(g => {
        const level = getRiskLevel(gaugeData[g.key].value, g);
        if (level) counts[level]++;
      });
      const status = getOverallStatus(counts, decisionGauges.length);

      const ctx = `Dashboard: ${status.level}
Decision-grade gauges (${decisionGauges.length}): Safe ${counts.safe} | Warning ${counts.warning} | Danger ${counts.danger}

DECISION-GRADE DATA:
${gaugeContext || 'None available'}

CONTEXT DATA:
${contextText || 'None available'}`;

      try {
        const bearResp = await fetch(`${PROXY}/claude`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 1500,
            messages: [{ role: 'user', content: `${ctx}\n\nWrite 500-600 words: STRONGEST case AI IS a bubble. No hedging. Use the decision-grade data. Draw parallels to dot-com/housing/crypto. End with prediction.` }]
          })
        });
        const bearData = await bearResp.json();

        const bullResp = await fetch(`${PROXY}/claude`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 1500,
            messages: [{ role: 'user', content: `${ctx}\n\nWrite 500-600 words: STRONGEST case AI is NOT a bubble. No hedging. Explain why this time IS different. End with prediction.` }]
          })
        });
        const bullData = await bullResp.json();

        debateEssays = {
          bear: bearData.content?.[0]?.text || 'Failed',
          bull: bullData.content?.[0]?.text || 'Failed',
          generatedAt: new Date()
        };
      } catch (e) {
        debateEssays = { bear: 'Error: ' + e.message, bull: 'Error: ' + e.message, generatedAt: new Date() };
      }

      isGeneratingDebate = false;
      render();
    }

    function formatValue(value, gauge) {
      if (value === null || value === undefined) return '‚Äî';
      if (gauge.unit === 'ratio') return value.toFixed(2);
      if (gauge.unit === '%') return value.toFixed(1) + '%';
      if (gauge.unit === 'P/E' || gauge.unit === 'VIX') return value.toFixed(1);
      if (gauge.unit === 'score') return Math.round(value);
      return value.toFixed(2);
    }

    function selectGauge(key) { selectedGauge = selectedGauge === key ? null : key; render(); }

    function getQualityBadge(quality) {
      if (quality === 'LIVE') return '<span class="inline-flex items-center gap-1 text-emerald-400 text-xs font-medium"><span class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></span>Live</span>';
      if (quality === 'LAGGED') return '<span class="inline-flex items-center gap-1 text-amber-400 text-xs font-medium"><span class="w-2 h-2 bg-amber-400 rounded-full"></span>Lagged</span>';
      if (quality === 'AI_ANALYZED') return '<span class="inline-flex items-center gap-1 text-indigo-400 text-xs font-medium"><span class="w-2 h-2 bg-indigo-400 rounded-full"></span>AI</span>';
      if (quality === 'APPROXIMATE') return '<span class="inline-flex items-center gap-1 text-slate-400 text-xs font-medium"><span class="w-2 h-2 bg-slate-400 rounded-full"></span>Approx</span>';
      if (quality === 'AWAITING_ANALYSIS') return '<span class="inline-flex items-center gap-1 text-slate-500 text-xs"><span class="w-2 h-2 bg-slate-500 rounded-full"></span>Pending</span>';
      return '<span class="inline-flex items-center gap-1 text-red-400 text-xs"><span class="w-2 h-2 bg-red-400 rounded-full"></span>No Data</span>';
    }

    function render() {
      const app = document.getElementById('app');
      
      if (isLoading) {
        app.innerHTML = `
          <div class="flex flex-col items-center justify-center min-h-screen">
            <div class="w-16 h-16 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-xl text-slate-400">Fetching live market data...</p>
            <p class="text-sm text-slate-500 mt-2">This may take 30-60 seconds</p>
          </div>`;
        return;
      }

      const counts = { safe: 0, warning: 0, danger: 0 };
      let totalDecisionGrade = 0;
      let totalContext = 0;
      let totalNoData = 0;

      GAUGES.forEach(g => {
        const d = gaugeData[g.key];
        if (contributesToAssessment(d)) {
          const level = getRiskLevel(d.value, g);
          if (level) { counts[level]++; totalDecisionGrade++; }
        } else if (d?.value !== null && d?.value !== undefined) {
          totalContext++;
        } else {
          totalNoData++;
        }
      });
      
      const status = getOverallStatus(counts, totalDecisionGrade);
      const selGauge = GAUGES.find(g => g.key === selectedGauge);
      const selData = selectedGauge ? gaugeData[selectedGauge] : null;
      const selLevel = selGauge && selData?.value !== null ? getRiskLevel(selData.value, selGauge) : null;
      const selIsDecisionGrade = selData ? contributesToAssessment(selData) : false;

      app.innerHTML = `
        <div class="mb-8">
          <div class="flex items-center gap-3 mb-2">
            <div class="w-3 h-3 rounded-full bg-cyan-400 animate-pulse-slow"></div>
            <span class="text-cyan-400 text-xs uppercase tracking-widest">Decision-Grade Data</span>
          </div>
          <h1 class="text-4xl font-black mb-1">AI Bubble Tracker</h1>
          <p class="text-slate-500">Updated: ${lastUpdated?.toLocaleTimeString() || 'Never'} ‚Ä¢ Click any gauge for details</p>
        </div>

        <div class="rounded-2xl p-8 mb-8 gauge-glow" style="background: linear-gradient(135deg, ${status.color}22, ${status.color}08); border: 2px solid ${status.color}66;">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
            <div>
              <div class="text-slate-400 text-sm uppercase tracking-wider mb-2">Assessment (${totalDecisionGrade} decision-grade gauges)</div>
              <div class="text-5xl font-black mb-2" style="color: ${status.color}">${status.level}</div>
              <div class="text-slate-300 text-lg max-w-xl">${status.action}</div>
            </div>
            <div class="flex gap-4">
              <div class="text-center"><div class="text-3xl font-bold text-emerald-400">${counts.safe}</div><div class="text-xs text-slate-500 uppercase">Safe</div></div>
              <div class="text-center"><div class="text-3xl font-bold text-amber-400">${counts.warning}</div><div class="text-xs text-slate-500 uppercase">Warning</div></div>
              <div class="text-center"><div class="text-3xl font-bold text-red-400">${counts.danger}</div><div class="text-xs text-slate-500 uppercase">Danger</div></div>
              <div class="text-center border-l border-slate-700 pl-4"><div class="text-3xl font-bold text-slate-500">${totalContext}</div><div class="text-xs text-slate-500 uppercase">Context</div></div>
              <div class="text-center"><div class="text-3xl font-bold text-slate-600">${totalNoData}</div><div class="text-xs text-slate-500 uppercase">No Data</div></div>
            </div>
          </div>
          <div class="mt-6 h-3 rounded-full overflow-hidden bg-slate-800 flex">
            <div class="h-full bg-emerald-500" style="width: ${(counts.safe / 8) * 100}%"></div>
            <div class="h-full bg-amber-500" style="width: ${(counts.warning / 8) * 100}%"></div>
            <div class="h-full bg-red-500" style="width: ${(counts.danger / 8) * 100}%"></div>
            <div class="h-full bg-slate-500" style="width: ${(totalContext / 8) * 100}%"></div>
            <div class="h-full bg-slate-700" style="width: ${(totalNoData / 8) * 100}%"></div>
          </div>
        </div>

        <div class="mb-6 flex flex-wrap gap-3 justify-end">
          <button onclick="analyzeMaturity()" class="px-4 py-2 bg-indigo-500/20 text-indigo-400 rounded-lg hover:bg-indigo-500/30 transition flex items-center gap-2" ${isAnalyzingMaturity ? 'disabled' : ''}>
            ${isAnalyzingMaturity ? '<span class="w-4 h-4 border-2 border-indigo-400 border-t-transparent rounded-full animate-spin"></span>' : 'üîç'}
            ${isAnalyzingMaturity ? 'Analyzing...' : 'Analyze AI Maturity'}
          </button>
          <button onclick="generateDebate()" class="px-4 py-2 bg-purple-500/20 text-purple-400 rounded-lg hover:bg-purple-500/30 transition flex items-center gap-2" ${isGeneratingDebate ? 'disabled' : ''}>
            ${isGeneratingDebate ? '<span class="w-4 h-4 border-2 border-purple-400 border-t-transparent rounded-full animate-spin"></span>' : 'üí¨'}
            ${isGeneratingDebate ? 'Generating...' : 'Generate Debate'}
          </button>
          <button onclick="fetchAllData()" class="px-4 py-2 bg-cyan-500/20 text-cyan-400 rounded-lg hover:bg-cyan-500/30 transition flex items-center gap-2">
            üîÑ Refresh
          </button>
        </div>

        ${debateEssays ? `
          <div class="mb-8">
            <h2 class="text-2xl font-bold mb-2">The Debate</h2>
            <p class="text-slate-500 text-sm mb-4">Generated ${debateEssays.generatedAt.toLocaleTimeString()} ‚Ä¢ Based on ${totalDecisionGrade} decision-grade gauges</p>
            <div class="grid md:grid-cols-2 gap-6">
              <div class="bg-red-500/5 border border-red-500/20 rounded-xl p-6">
                <h3 class="text-xl font-bold text-red-400 mb-4">üî¥ Case for Bubble</h3>
                <div class="prose text-slate-300 text-sm whitespace-pre-line">${debateEssays.bear}</div>
              </div>
              <div class="bg-emerald-500/5 border border-emerald-500/20 rounded-xl p-6">
                <h3 class="text-xl font-bold text-emerald-400 mb-4">üü¢ Case Against Bubble</h3>
                <div class="prose text-slate-300 text-sm whitespace-pre-line">${debateEssays.bull}</div>
              </div>
            </div>
          </div>
        ` : ''}

        ${selGauge ? `
          <div class="mb-8 bg-slate-800/70 border ${selIsDecisionGrade ? 'border-cyan-700' : 'border-slate-700'} rounded-2xl p-6">
            <div class="flex justify-between items-start mb-4">
              <div>
                <div class="flex items-center gap-2 mb-1">
                  <span class="text-xs text-slate-500 uppercase">${selGauge.category}</span>
                  ${selIsDecisionGrade ? '<span class="text-xs bg-cyan-500/20 text-cyan-400 px-2 py-0.5 rounded">DECISION GRADE</span>' : '<span class="text-xs bg-slate-500/20 text-slate-400 px-2 py-0.5 rounded">CONTEXT ONLY</span>'}
                </div>
                <h2 class="text-2xl font-bold text-white">${selGauge.name}</h2>
              </div>
              <button onclick="selectGauge(null)" class="text-slate-400 hover:text-white text-2xl">√ó</button>
            </div>
            
            <div class="grid md:grid-cols-3 gap-4 mb-6">
              <div class="bg-slate-900/50 rounded-lg p-4">
                <div class="text-slate-500 text-xs uppercase mb-1">Current Value</div>
                ${selData?.value !== null ? `
                  <div class="text-3xl font-bold" style="color: ${{safe:'#10b981',warning:'#f59e0b',danger:'#ef4444'}[selLevel] || '#6b7280'}">${formatValue(selData?.value, selGauge)}</div>
                ` : `
                  <div class="text-3xl font-bold text-slate-500">No Data</div>
                `}
                <div class="mt-1">${getQualityBadge(selData?.quality)}</div>
                <div class="text-xs text-slate-500 mt-1">${selData?.source || 'Unknown'}</div>
              </div>
              <div class="bg-slate-900/50 rounded-lg p-4">
                <div class="text-slate-500 text-xs uppercase mb-1">Safe Threshold</div>
                <div class="text-2xl font-bold text-emerald-400">${selGauge.inverted ? '‚â•' : '‚â§'} ${formatValue(selGauge.safe, selGauge)}</div>
              </div>
              <div class="bg-slate-900/50 rounded-lg p-4">
                <div class="text-slate-500 text-xs uppercase mb-1">Danger Threshold</div>
                <div class="text-2xl font-bold text-red-400">${selGauge.inverted ? '<' : '>'} ${formatValue(selGauge.warn, selGauge)}</div>
              </div>
            </div>

            ${selData?.note ? `
              <div class="bg-amber-500/10 border border-amber-500/30 rounded-lg p-3 mb-4">
                <div class="text-amber-400 text-sm">‚ö†Ô∏è ${selData.note}</div>
              </div>
            ` : ''}

            ${selData?.reasoning ? `
              <div class="bg-indigo-500/10 border border-indigo-500/30 rounded-lg p-4 mb-4">
                <div class="text-indigo-400 font-semibold mb-2">ü§ñ Claude's Analysis</div>
                <p class="text-slate-300 text-sm">${selData.reasoning}</p>
                ${selData.signals ? `<div class="mt-2 flex flex-wrap gap-2">${selData.signals.map(s => `<span class="px-2 py-1 bg-indigo-500/20 rounded text-xs text-indigo-300">${s}</span>`).join('')}</div>` : ''}
              </div>
            ` : ''}

            <div class="space-y-4 text-sm">
              <div><h3 class="text-cyan-400 font-semibold mb-1">What It Measures</h3><p class="text-slate-300">${selGauge.meaning}</p></div>
              <div><h3 class="text-cyan-400 font-semibold mb-1">How It's Calculated</h3><p class="text-slate-300">${selGauge.calculation}</p></div>
              <div><h3 class="text-cyan-400 font-semibold mb-1">Why It Matters</h3><p class="text-slate-300">${selGauge.whyItMatters}</p></div>
              <div><h3 class="text-cyan-400 font-semibold mb-1">Thresholds</h3><p class="text-slate-300">${selGauge.thresholds}</p></div>
            </div>
          </div>
        ` : ''}

        <h3 class="text-lg font-bold mb-3 text-slate-300">Decision-Grade Gauges</h3>
        <p class="text-xs text-slate-500 mb-4">Only LIVE and LAGGED data drives the assessment</p>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
          ${GAUGES.filter(g => !['mag7-breadth', 'app-maturity'].includes(g.key)).map(g => {
            const d = gaugeData[g.key];
            const hasData = d?.value !== null && d?.value !== undefined;
            const level = hasData ? getRiskLevel(d.value, g) : null;
            const colors = level ? {
              safe: { bg: 'rgba(16,185,129,0.15)', border: 'rgba(16,185,129,0.4)', text: '#10b981' },
              warning: { bg: 'rgba(245,158,11,0.15)', border: 'rgba(245,158,11,0.4)', text: '#f59e0b' },
              danger: { bg: 'rgba(239,68,68,0.15)', border: 'rgba(239,68,68,0.4)', text: '#ef4444' }
            }[level] : { bg: 'rgba(100,116,139,0.1)', border: 'rgba(100,116,139,0.3)', text: '#64748b' };
            const isSelected = selectedGauge === g.key;
            
            return `
              <div onclick="selectGauge('${g.key}')" class="p-4 rounded-xl cursor-pointer hover:scale-105 transition-all ${isSelected ? 'ring-2 ring-cyan-500' : ''} ${!hasData ? 'no-data' : ''}" style="background: ${colors.bg}; border: 2px solid ${colors.border};">
                <div class="flex justify-between items-start mb-1">
                  <div class="text-xs text-slate-500 uppercase">${g.category}</div>
                  ${getQualityBadge(d?.quality)}
                </div>
                <div class="text-sm font-semibold text-slate-200 mb-3">${g.name}</div>
                <div class="text-2xl font-bold mb-1" style="color: ${colors.text}">${hasData ? formatValue(d.value, g) : 'No Data'}</div>
                <div class="text-xs text-slate-500 truncate">${d?.source || 'Unavailable'}</div>
              </div>`;
          }).join('')}
        </div>

        <h3 class="text-lg font-bold mb-3 text-slate-400">Context Gauges</h3>
        <p class="text-xs text-slate-500 mb-4">Displayed for reference but DO NOT affect the assessment</p>
        <div class="grid grid-cols-2 gap-4 mb-8">
          ${GAUGES.filter(g => ['mag7-breadth', 'app-maturity'].includes(g.key)).map(g => {
            const d = gaugeData[g.key];
            const hasData = d?.value !== null && d?.value !== undefined;
            const colors = { bg: 'rgba(100,116,139,0.08)', border: 'rgba(100,116,139,0.25)', text: '#94a3b8' };
            const isSelected = selectedGauge === g.key;
            
            return `
              <div onclick="selectGauge('${g.key}')" class="p-4 rounded-xl cursor-pointer hover:scale-105 transition-all context-only ${isSelected ? 'ring-2 ring-slate-500' : ''} ${!hasData ? 'no-data' : ''}" style="background: ${colors.bg}; border: 1px dashed ${colors.border};">
                <div class="flex justify-between items-start mb-1">
                  <div class="text-xs text-slate-500 uppercase">${g.category}</div>
                  ${getQualityBadge(d?.quality)}
                </div>
                <div class="text-sm font-semibold text-slate-300 mb-3">${g.name}</div>
                <div class="text-2xl font-bold mb-1" style="color: ${colors.text}">${hasData ? formatValue(d.value, g) : 'No Data'}</div>
                <div class="text-xs text-slate-500 truncate">${d?.source || 'Unavailable'}</div>
              </div>`;
          }).join('')}
        </div>

        <div class="bg-slate-800/50 rounded-xl p-6 mb-8">
          <h2 class="text-lg font-bold mb-4">Risk Framework</h2>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
            <div class="p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/30"><div class="font-semibold text-emerald-400">NORMAL</div><div class="text-slate-400">0-1 danger</div></div>
            <div class="p-3 rounded-lg bg-amber-500/10 border border-amber-500/30"><div class="font-semibold text-amber-400">CAUTION</div><div class="text-slate-400">1 danger OR 4+ warnings</div></div>
            <div class="p-3 rounded-lg bg-orange-500/10 border border-orange-500/30"><div class="font-semibold text-orange-400">OVERHEATING</div><div class="text-slate-400">2-3 danger</div></div>
            <div class="p-3 rounded-lg bg-red-500/10 border border-red-500/30"><div class="font-semibold text-red-400">BUBBLE</div><div class="text-slate-400">4+ danger</div></div>
          </div>
        </div>

        <div class="bg-slate-800/30 rounded-xl p-4 mb-8">
          <h3 class="text-sm font-semibold text-slate-400 mb-2">Data Quality Tiers</h3>
          <div class="flex flex-wrap items-center gap-4 text-xs">
            <span class="flex items-center gap-2"><span class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></span><span class="text-slate-400"><strong>Live</strong> = Real-time API ‚Üí Drives assessment</span></span>
            <span class="flex items-center gap-2"><span class="w-2 h-2 bg-amber-400 rounded-full"></span><span class="text-slate-400"><strong>Lagged</strong> = Quarterly data ‚Üí Drives assessment</span></span>
            <span class="flex items-center gap-2"><span class="w-2 h-2 bg-slate-400 rounded-full"></span><span class="text-slate-400"><strong>Approx</strong> = Has assumptions ‚Üí Context only</span></span>
            <span class="flex items-center gap-2"><span class="w-2 h-2 bg-indigo-400 rounded-full"></span><span class="text-slate-400"><strong>AI</strong> = Claude estimate ‚Üí Context only</span></span>
            <span class="flex items-center gap-2"><span class="w-2 h-2 bg-red-400 rounded-full"></span><span class="text-slate-400"><strong>No Data</strong> = API failed ‚Üí Excluded</span></span>
          </div>
        </div>

        <div class="text-center text-slate-600 text-xs">Only Live + Lagged gauges affect the assessment ‚Ä¢ Context gauges shown for reference only ‚Ä¢ Not investment advice</div>
      `;
    }

    fetchAllData();
  </script>
</body>
</html>
