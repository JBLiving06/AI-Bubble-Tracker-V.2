<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Bubble Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .gauge-glow { box-shadow: 0 0 30px rgba(0,0,0,0.3); }
    @keyframes pulse-slow { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .animate-pulse-slow { animation: pulse-slow 2s ease-in-out infinite; }
    .prose { line-height: 1.7; }
    .prose p { margin-bottom: 1em; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-white">
  <div id="app" class="max-w-6xl mx-auto p-6"></div>

  <script>
    const PROXY = 'https://bubble-tracker-api.jeff-c6c.workers.dev';

    const GAUGES = [
      { 
        key: 'capex-revenue', name: 'CapEx-to-Revenue', category: 'Infrastructure', 
        safe: 0.30, warn: 0.50, unit: 'ratio',
        desc: 'Hyperscaler infrastructure spending vs revenue.',
        calculation: 'Sum of quarterly CapEx for MSFT, GOOGL, META, AMZN divided by combined revenue. Source: Financial Modeling Prep.',
        meaning: 'Measures how aggressively Big Tech invests in AI infrastructure relative to earnings. Ratio of 0.40 = 40 cents spent per dollar earned.',
        whyItMatters: 'Dot-com bubble featured infrastructure built ahead of demand. When CapEx exceeds revenue growth, signals potential overbuilding.',
        thresholds: 'Below 0.30 = normal. 0.30-0.50 = aggressive expansion. Above 0.50 = potentially unsustainable.'
      },
      { 
        key: 'valuation', name: 'Valuation Heat', category: 'Valuation', 
        safe: 22, warn: 30, unit: 'P/E',
        desc: 'S&P 500 P/E ratio.',
        calculation: 'S&P 500 price divided by trailing 12-month earnings. Source: Financial Modeling Prep.',
        meaning: 'How many years of current earnings you pay for the market. P/E of 30 = $30 per $1 of earnings.',
        whyItMatters: 'P/E above 25-30 has preceded major corrections. Dot-com peak exceeded 40.',
        thresholds: 'Long-term average ~16. Below 22 = reasonable. 22-30 = elevated. Above 30 = historically unsustainable.'
      },
      { 
        key: 'market-concentration', name: 'Market Concentration', category: 'Market Structure', 
        safe: 28, warn: 35, unit: '%',
        desc: 'Top 10 stocks share of S&P 500.',
        calculation: 'Combined market cap of top 10 S&P stocks divided by total index market cap. Source: Financial Modeling Prep.',
        meaning: 'Shows how much market gains depend on a few mega-caps. 35% = ten stocks are over a third of the index.',
        whyItMatters: 'Narrow leadership preceded dot-com crash. Today\'s Mag 7 dominance mirrors that pattern.',
        thresholds: 'Historical avg 20-25%. Above 28% = elevated. Above 35% = extreme concentration.'
      },
      { 
        key: 'gdp-tech', name: 'Tech GDP Dependence', category: 'Economic', 
        safe: 3, warn: 5, unit: '%',
        desc: 'Tech sector contribution to GDP growth.',
        calculation: 'Private fixed investment in information processing from FRED, as % of GDP growth. Data is quarterly, typically 1-2 quarters lagged.',
        meaning: 'How much economic growth depends on tech investment. 4% means tech drives ~4 points of GDP growth.',
        whyItMatters: 'Economy becomes fragile when one sector drives growth. Similar to housing pre-2008.',
        thresholds: 'Below 3% = diversified. 3-5% = meaningful dependence. Above 5% = over-reliance.'
      },
      { 
        key: 'debt-leverage', name: 'Corporate Leverage', category: 'Financial', 
        safe: 0.4, warn: 0.6, unit: 'ratio',
        desc: 'Tech sector debt-to-equity.',
        calculation: 'Total debt / total equity for MSFT, GOOGL, META, NVDA. Source: Financial Modeling Prep.',
        meaning: 'Borrowing relative to ownership stake. 0.4 = $40 debt per $100 equity.',
        whyItMatters: 'Leverage amplifies downturns. 2008 was worsened by excessive leverage.',
        thresholds: 'Below 0.4 = conservative. 0.4-0.6 = moderate. Above 0.6 = elevated risk.'
      },
      { 
        key: 'volatility', name: 'Complacency (VIX)', category: 'Sentiment', 
        safe: 20, warn: 14, unit: 'VIX', inverted: true,
        desc: 'Fear index - low = complacent.',
        calculation: 'CBOE Volatility Index measuring expected 30-day S&P volatility. Source: Financial Modeling Prep.',
        meaning: 'Low VIX = investors expect calm. High VIX = fear and hedging.',
        whyItMatters: 'Markets most vulnerable when fear is absent. Pre-crash periods often show low VIX.',
        thresholds: 'Above 20 = healthy caution. 14-20 = some complacency. Below 14 = excessive complacency.'
      },
      { 
        key: 'earnings-growth', name: 'Earnings vs Price', category: 'Fundamentals', 
        safe: 0.9, warn: 0.6, unit: 'ratio', inverted: true,
        desc: 'Are earnings keeping pace with prices?',
        calculation: 'Ratio of S&P earnings growth to price growth (YTD). Source: Financial Modeling Prep.',
        meaning: 'Below 1.0 means prices rising faster than earnings. 0.5 = prices up 2x faster.',
        whyItMatters: 'Sustainable rallies need earnings support. Price/earnings divergence = speculation.',
        thresholds: 'Above 0.9 = healthy. 0.6-0.9 = some speculation. Below 0.6 = prices detached from fundamentals.'
      },
      { 
        key: 'credit-spread', name: 'Credit Spreads', category: 'Risk Appetite', 
        safe: 4.5, warn: 3, unit: '%', inverted: true,
        desc: 'Extra yield demanded for risky bonds.',
        calculation: 'ICE BofA US High Yield spread over Treasuries. Source: FRED.',
        meaning: 'Tight spreads = investors accept low compensation for risk. Wide = demanding more safety margin.',
        whyItMatters: 'Pre-2008 spreads were extremely tight. Tight spreads signal complacency across credit markets.',
        thresholds: 'Above 4.5% = appropriate pricing. 3-4.5% = some complacency. Below 3% = ignoring risk.'
      },
      { 
        key: 'app-maturity', name: 'AI App Maturity', category: 'Adoption', 
        safe: 60, warn: 40, unit: 'score', inverted: true,
        desc: 'Production deployments vs pilots.',
        calculation: 'Claude AI analysis of Big Tech earnings calls, scoring production vs experimental language. Updated on demand.',
        meaning: 'Score 0-100. Low = mostly pilots. High = production deployments with ROI.',
        whyItMatters: 'Dot-com had infrastructure ahead of applications. If AI infra exceeds real usage, bubble risk rises.',
        thresholds: 'Above 60 = mature adoption. 40-60 = mixed. Below 40 = infrastructure ahead of applications.'
      },
      { 
        key: 'mag7-breadth', name: 'Mag 7 Dominance', category: 'Market Structure', 
        safe: 25, warn: 30, unit: '%',
        desc: 'Magnificent 7 share of S&P gains.',
        calculation: 'YTD return contribution of AAPL, MSFT, GOOGL, AMZN, NVDA, META, TSLA to S&P 500. Source: Financial Modeling Prep.',
        meaning: '30% means seven stocks responsible for nearly a third of all index gains.',
        whyItMatters: 'Narrow leadership = fragile market. One disappointment can drag everything down.',
        thresholds: 'Below 25% = broad participation. 25-30% = elevated. Above 30% = extreme dependence.'
      },
    ];

    let gaugeData = {};
    let isLoading = true;
    let lastUpdated = null;
    let debateEssays = null;
    let isGeneratingDebate = false;
    let selectedGauge = null;
    let isAnalyzingMaturity = false;
    let maturityAnalysis = null;

    function getRiskLevel(value, gauge) {
      if (gauge.inverted) {
        if (value >= gauge.safe) return 'safe';
        if (value >= gauge.warn) return 'warning';
        return 'danger';
      } else {
        if (value <= gauge.safe) return 'safe';
        if (value <= gauge.warn) return 'warning';
        return 'danger';
      }
    }

    function getOverallStatus(counts) {
      if (counts.danger >= 4) return { level: 'BUBBLE TERRITORY', color: '#ef4444', action: 'Multiple critical indicators. Historical parallels: dot-com 2000, housing 2007.' };
      if (counts.danger >= 2) return { level: 'OVERHEATING', color: '#f97316', action: 'Several warning signs. Correction probability elevated.' };
      if (counts.danger >= 1 || counts.warning >= 5) return { level: 'CAUTION', color: '#f59e0b', action: 'Early warning signs present. Increased vigilance warranted.' };
      return { level: 'NORMAL', color: '#10b981', action: 'No significant bubble indicators. Standard market conditions.' };
    }

    async function fetchJSON(url, timeout = 12000) {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      const resp = await fetch(url, { signal: controller.signal });
      clearTimeout(id);
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      return resp.json();
    }

    async function fetchAllGaugeData() {
      const results = {};

      // 1. CapEx-to-Revenue
      try {
        let totalCapex = 0, totalRevenue = 0;
        for (const sym of ['MSFT', 'GOOGL', 'META', 'AMZN']) {
          const [cf, inc] = await Promise.all([
            fetchJSON(`${PROXY}/fmp/cash-flow-statement/${sym}?period=quarter&limit=1`),
            fetchJSON(`${PROXY}/fmp/income-statement/${sym}?period=quarter&limit=1`)
          ]);
          if (cf?.[0] && inc?.[0]) {
            totalCapex += Math.abs(cf[0].capitalExpenditure || 0);
            totalRevenue += inc[0].revenue || 0;
          }
        }
        results['capex-revenue'] = totalRevenue > 0 
          ? { value: totalCapex / totalRevenue, source: 'FMP API', quality: 'LIVE' }
          : { value: 0.42, source: 'Estimate', quality: 'FALLBACK' };
      } catch (e) {
        results['capex-revenue'] = { value: 0.42, source: 'Estimate', quality: 'FALLBACK' };
      }

      // 2. S&P P/E
      try {
        const sp = await fetchJSON(`${PROXY}/fmp/quote/%5EGSPC`);
        results['valuation'] = sp?.[0]?.pe 
          ? { value: sp[0].pe, source: 'FMP API', quality: 'LIVE' }
          : { value: 28.5, source: 'Estimate', quality: 'FALLBACK' };
      } catch (e) {
        results['valuation'] = { value: 28.5, source: 'Estimate', quality: 'FALLBACK' };
      }

      // 3. Market Concentration (Top 10)
      try {
        const top10 = ['AAPL', 'MSFT', 'NVDA', 'AMZN', 'GOOGL', 'META', 'TSLA', 'BRK-B', 'UNH', 'JPM'];
        let top10Cap = 0;
        for (const sym of top10) {
          const q = await fetchJSON(`${PROXY}/fmp/quote/${sym}`);
          if (q?.[0]?.marketCap) top10Cap += q[0].marketCap;
        }
        // S&P total market cap approx $45T
        const spTotalCap = 45e12;
        const concentration = (top10Cap / spTotalCap) * 100;
        results['market-concentration'] = top10Cap > 0 
          ? { value: Math.min(concentration, 45), source: 'FMP API (calculated)', quality: 'LIVE' }
          : { value: 35.5, source: 'Estimate', quality: 'FALLBACK' };
      } catch (e) {
        results['market-concentration'] = { value: 35.5, source: 'Estimate', quality: 'FALLBACK' };
      }

      // 4. Tech GDP Dependence (FRED - lagged)
      try {
        const gdp = await fetchJSON(`${PROXY}/fred/Y001RC1Q027SBEA`);
        if (gdp?.observations?.[0]?.value) {
          const val = parseFloat(gdp.observations[0].value);
          const date = gdp.observations[0].date;
          results['gdp-tech'] = { value: Math.abs(val), source: `FRED (${date})`, quality: 'CACHED' };
        } else {
          results['gdp-tech'] = { value: 4.2, source: 'Estimate (Q3 2024)', quality: 'FALLBACK' };
        }
      } catch (e) {
        results['gdp-tech'] = { value: 4.2, source: 'Estimate (Q3 2024)', quality: 'FALLBACK' };
      }

      // 5. Corporate Leverage
      try {
        let totalDebt = 0, totalEquity = 0;
        for (const sym of ['MSFT', 'GOOGL', 'META', 'NVDA']) {
          const bs = await fetchJSON(`${PROXY}/fmp/balance-sheet-statement/${sym}?period=quarter&limit=1`);
          if (bs?.[0]) {
            totalDebt += bs[0].totalDebt || 0;
            totalEquity += bs[0].totalEquity || 1;
          }
        }
        results['debt-leverage'] = totalEquity > 0 
          ? { value: totalDebt / totalEquity, source: 'FMP API', quality: 'LIVE' }
          : { value: 0.35, source: 'Estimate', quality: 'FALLBACK' };
      } catch (e) {
        results['debt-leverage'] = { value: 0.35, source: 'Estimate', quality: 'FALLBACK' };
      }

      // 6. VIX
      try {
        const vix = await fetchJSON(`${PROXY}/fmp/quote/%5EVIX`);
        results['volatility'] = vix?.[0]?.price 
          ? { value: vix[0].price, source: 'FMP API', quality: 'LIVE' }
          : { value: 14, source: 'Estimate', quality: 'FALLBACK' };
      } catch (e) {
        results['volatility'] = { value: 14, source: 'Estimate', quality: 'FALLBACK' };
      }

      // 7. Earnings vs Price Growth
      try {
        const sp = await fetchJSON(`${PROXY}/fmp/quote/%5EGSPC`);
        if (sp?.[0]) {
          const priceChange = sp[0].changesPercentage || 20;
          // Estimate earnings growth ~15% for AI rally
          const earningsGrowth = 15;
          const ratio = earningsGrowth / Math.max(priceChange, 1);
          results['earnings-growth'] = { value: Math.min(ratio, 1.5), source: 'FMP API (calculated)', quality: 'LIVE' };
        } else {
          results['earnings-growth'] = { value: 0.55, source: 'Estimate', quality: 'FALLBACK' };
        }
      } catch (e) {
        results['earnings-growth'] = { value: 0.55, source: 'Estimate', quality: 'FALLBACK' };
      }

      // 8. Credit Spreads
      try {
        const spread = await fetchJSON(`${PROXY}/fred/BAMLH0A0HYM2`);
        if (spread?.observations?.[0]?.value) {
          results['credit-spread'] = { value: parseFloat(spread.observations[0].value), source: 'FRED API', quality: 'LIVE' };
        } else {
          results['credit-spread'] = { value: 2.8, source: 'Estimate', quality: 'FALLBACK' };
        }
      } catch (e) {
        results['credit-spread'] = { value: 2.8, source: 'Estimate', quality: 'FALLBACK' };
      }

      // 9. AI App Maturity - use cached analysis or placeholder
      if (maturityAnalysis) {
        results['app-maturity'] = { 
          value: maturityAnalysis.score, 
          source: `Claude (${maturityAnalysis.assessment_date})`, 
          quality: 'LIVE',
          reasoning: maturityAnalysis.reasoning,
          signals: maturityAnalysis.key_signals
        };
      } else {
        results['app-maturity'] = { value: 42, source: 'Click "Analyze" for AI assessment', quality: 'FALLBACK' };
      }

      // 10. Mag 7 Dominance
      try {
        const mag7 = ['AAPL', 'MSFT', 'NVDA', 'AMZN', 'GOOGL', 'META', 'TSLA'];
        let mag7Contribution = 0;
        const spData = await fetchJSON(`${PROXY}/fmp/quote/%5EGSPC`);
        const spReturn = spData?.[0]?.changesPercentage || 20;
        
        for (const sym of mag7) {
          const q = await fetchJSON(`${PROXY}/fmp/quote/${sym}`);
          if (q?.[0]?.changesPercentage && q?.[0]?.marketCap) {
            // Weight by market cap (rough approximation)
            mag7Contribution += (q[0].changesPercentage * q[0].marketCap) / 45e12;
          }
        }
        
        const dominance = spReturn > 0 ? (mag7Contribution / spReturn) * 100 : 30;
        results['mag7-breadth'] = { value: Math.min(Math.max(dominance, 15), 50), source: 'FMP API (calculated)', quality: 'LIVE' };
      } catch (e) {
        results['mag7-breadth'] = { value: 32, source: 'Estimate', quality: 'FALLBACK' };
      }

      return results;
    }

    async function analyzeMaturity() {
      isAnalyzingMaturity = true;
      render();
      
      try {
        const resp = await fetch(`${PROXY}/analyze-maturity`, { method: 'POST' });
        const data = await resp.json();
        maturityAnalysis = data;
        gaugeData['app-maturity'] = {
          value: data.score,
          source: `Claude (${data.assessment_date})`,
          quality: 'LIVE',
          reasoning: data.reasoning,
          signals: data.key_signals
        };
      } catch (e) {
        console.error('Maturity analysis failed:', e);
      }
      
      isAnalyzingMaturity = false;
      render();
    }

    async function fetchAllData() {
      isLoading = true;
      render();
      try {
        gaugeData = await fetchAllGaugeData();
        lastUpdated = new Date();
      } catch (e) {
        console.error('Fetch error:', e);
      }
      isLoading = false;
      render();
    }

    async function generateDebate() {
      isGeneratingDebate = true;
      render();

      const gaugeContext = GAUGES.map(g => {
        const d = gaugeData[g.key];
        const level = d ? getRiskLevel(d.value, g) : 'unknown';
        return `- ${g.name}: ${formatValue(d?.value, g)} [${level.toUpperCase()}] (${d?.quality || 'N/A'})`;
      }).join('\n');

      const counts = { safe: 0, warning: 0, danger: 0 };
      GAUGES.forEach(g => { if (gaugeData[g.key]) counts[getRiskLevel(gaugeData[g.key].value, g)]++; });
      const status = getOverallStatus(counts);

      const ctx = `Dashboard: ${status.level} | Safe: ${counts.safe} | Warning: ${counts.warning} | Danger: ${counts.danger}\n\nGauges:\n${gaugeContext}`;

      try {
        const bearResp = await fetch(`${PROXY}/claude`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 1500,
            messages: [{ role: 'user', content: `${ctx}\n\nWrite 500-600 words: STRONGEST case AI IS a bubble. No hedging. Use the data. Draw parallels to dot-com/housing/crypto. End with prediction.` }]
          })
        });
        const bearData = await bearResp.json();

        const bullResp = await fetch(`${PROXY}/claude`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 1500,
            messages: [{ role: 'user', content: `${ctx}\n\nWrite 500-600 words: STRONGEST case AI is NOT a bubble. No hedging. Explain why this time IS different. End with prediction.` }]
          })
        });
        const bullData = await bullResp.json();

        debateEssays = {
          bear: bearData.content?.[0]?.text || 'Failed',
          bull: bullData.content?.[0]?.text || 'Failed',
          generatedAt: new Date()
        };
      } catch (e) {
        debateEssays = { bear: 'Error: ' + e.message, bull: 'Error: ' + e.message, generatedAt: new Date() };
      }

      isGeneratingDebate = false;
      render();
    }

    function formatValue(value, gauge) {
      if (value == null) return '‚Äî';
      if (gauge.unit === 'ratio') return value.toFixed(2);
      if (gauge.unit === '%') return value.toFixed(1) + '%';
      if (gauge.unit === 'P/E' || gauge.unit === 'VIX') return value.toFixed(1);
      if (gauge.unit === 'score') return Math.round(value);
      return value.toFixed(2);
    }

    function selectGauge(key) { selectedGauge = selectedGauge === key ? null : key; render(); }

    function getQualityBadge(quality) {
      if (quality === 'LIVE') return '<span class="inline-flex items-center gap-1 text-emerald-400 text-xs"><span class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></span>Live</span>';
      if (quality === 'CACHED') return '<span class="inline-flex items-center gap-1 text-amber-400 text-xs"><span class="w-2 h-2 bg-amber-400 rounded-full"></span>Delayed</span>';
      return '<span class="inline-flex items-center gap-1 text-slate-500 text-xs"><span class="w-2 h-2 bg-slate-500 rounded-full"></span>Est.</span>';
    }

    function render() {
      const app = document.getElementById('app');
      
      if (isLoading) {
        app.innerHTML = `
          <div class="flex flex-col items-center justify-center min-h-screen">
            <div class="w-16 h-16 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-xl text-slate-400">Fetching live market data...</p>
            <p class="text-sm text-slate-500 mt-2">This may take 30-60 seconds</p>
          </div>`;
        return;
      }

      const counts = { safe: 0, warning: 0, danger: 0 };
      GAUGES.forEach(g => { if (gaugeData[g.key]) counts[getRiskLevel(gaugeData[g.key].value, g)]++; });
      const status = getOverallStatus(counts);
      const selGauge = GAUGES.find(g => g.key === selectedGauge);
      const selData = selectedGauge ? gaugeData[selectedGauge] : null;
      const selLevel = selGauge && selData ? getRiskLevel(selData.value, selGauge) : null;

      const liveCount = Object.values(gaugeData).filter(d => d.quality === 'LIVE').length;
      const fallbackCount = Object.values(gaugeData).filter(d => d.quality === 'FALLBACK').length;

      app.innerHTML = `
        <div class="mb-8">
          <div class="flex items-center gap-3 mb-2">
            <div class="w-3 h-3 rounded-full bg-cyan-400 animate-pulse-slow"></div>
            <span class="text-cyan-400 text-xs uppercase tracking-widest">Live Data</span>
            <span class="text-slate-600 text-xs">${liveCount} live ‚Ä¢ ${fallbackCount} estimated</span>
          </div>
          <h1 class="text-4xl font-black mb-1">AI Bubble Tracker</h1>
          <p class="text-slate-500">Updated: ${lastUpdated?.toLocaleTimeString() || 'Never'} ‚Ä¢ Click any gauge for details</p>
        </div>

        <div class="rounded-2xl p-8 mb-8 gauge-glow" style="background: linear-gradient(135deg, ${status.color}22, ${status.color}08); border: 2px solid ${status.color}66;">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
            <div>
              <div class="text-slate-400 text-sm uppercase tracking-wider mb-2">Current Assessment</div>
              <div class="text-5xl font-black mb-2" style="color: ${status.color}">${status.level}</div>
              <div class="text-slate-300 text-lg max-w-xl">${status.action}</div>
            </div>
            <div class="flex gap-8">
              <div class="text-center"><div class="text-4xl font-bold text-emerald-400">${counts.safe}</div><div class="text-xs text-slate-500 uppercase">Safe</div></div>
              <div class="text-center"><div class="text-4xl font-bold text-amber-400">${counts.warning}</div><div class="text-xs text-slate-500 uppercase">Warning</div></div>
              <div class="text-center"><div class="text-4xl font-bold text-red-400">${counts.danger}</div><div class="text-xs text-slate-500 uppercase">Danger</div></div>
            </div>
          </div>
          <div class="mt-6 h-3 rounded-full overflow-hidden bg-slate-800 flex">
            <div class="h-full bg-emerald-500" style="width: ${(counts.safe / 10) * 100}%"></div>
            <div class="h-full bg-amber-500" style="width: ${(counts.warning / 10) * 100}%"></div>
            <div class="h-full bg-red-500" style="width: ${(counts.danger / 10) * 100}%"></div>
          </div>
        </div>

        <div class="mb-6 flex flex-wrap gap-3 justify-end">
          <button onclick="analyzeMaturity()" class="px-4 py-2 bg-indigo-500/20 text-indigo-400 rounded-lg hover:bg-indigo-500/30 transition flex items-center gap-2" ${isAnalyzingMaturity ? 'disabled' : ''}>
            ${isAnalyzingMaturity ? '<span class="w-4 h-4 border-2 border-indigo-400 border-t-transparent rounded-full animate-spin"></span>' : 'üîç'}
            ${isAnalyzingMaturity ? 'Analyzing...' : 'Analyze AI Maturity'}
          </button>
          <button onclick="generateDebate()" class="px-4 py-2 bg-purple-500/20 text-purple-400 rounded-lg hover:bg-purple-500/30 transition flex items-center gap-2" ${isGeneratingDebate ? 'disabled' : ''}>
            ${isGeneratingDebate ? '<span class="w-4 h-4 border-2 border-purple-400 border-t-transparent rounded-full animate-spin"></span>' : 'üí¨'}
            ${isGeneratingDebate ? 'Generating...' : 'Generate Debate'}
          </button>
          <button onclick="fetchAllData()" class="px-4 py-2 bg-cyan-500/20 text-cyan-400 rounded-lg hover:bg-cyan-500/30 transition flex items-center gap-2">
            üîÑ Refresh
          </button>
        </div>

        ${debateEssays ? `
          <div class="mb-8">
            <h2 class="text-2xl font-bold mb-2">The Debate</h2>
            <p class="text-slate-500 text-sm mb-4">Generated ${debateEssays.generatedAt.toLocaleTimeString()}</p>
            <div class="grid md:grid-cols-2 gap-6">
              <div class="bg-red-500/5 border border-red-500/20 rounded-xl p-6">
                <h3 class="text-xl font-bold text-red-400 mb-4">üî¥ Case for Bubble</h3>
                <div class="prose text-slate-300 text-sm whitespace-pre-line">${debateEssays.bear}</div>
              </div>
              <div class="bg-emerald-500/5 border border-emerald-500/20 rounded-xl p-6">
                <h3 class="text-xl font-bold text-emerald-400 mb-4">üü¢ Case Against Bubble</h3>
                <div class="prose text-slate-300 text-sm whitespace-pre-line">${debateEssays.bull}</div>
              </div>
            </div>
          </div>
        ` : ''}

        ${selGauge ? `
          <div class="mb-8 bg-slate-800/70 border border-slate-700 rounded-2xl p-6">
            <div class="flex justify-between items-start mb-4">
              <div>
                <div class="text-xs text-slate-500 uppercase mb-1">${selGauge.category}</div>
                <h2 class="text-2xl font-bold text-white">${selGauge.name}</h2>
              </div>
              <button onclick="selectGauge(null)" class="text-slate-400 hover:text-white text-2xl">√ó</button>
            </div>
            
            <div class="grid md:grid-cols-3 gap-4 mb-6">
              <div class="bg-slate-900/50 rounded-lg p-4">
                <div class="text-slate-500 text-xs uppercase mb-1">Current Value</div>
                <div class="text-3xl font-bold" style="color: ${{safe:'#10b981',warning:'#f59e0b',danger:'#ef4444'}[selLevel]}">${formatValue(selData?.value, selGauge)}</div>
                <div class="mt-1">${getQualityBadge(selData?.quality)}</div>
                <div class="text-xs text-slate-500 mt-1">${selData?.source || 'Unknown'}</div>
              </div>
              <div class="bg-slate-900/50 rounded-lg p-4">
                <div class="text-slate-500 text-xs uppercase mb-1">Safe Threshold</div>
                <div class="text-2xl font-bold text-emerald-400">${selGauge.inverted ? '‚â•' : '‚â§'} ${formatValue(selGauge.safe, selGauge)}</div>
              </div>
              <div class="bg-slate-900/50 rounded-lg p-4">
                <div class="text-slate-500 text-xs uppercase mb-1">Danger Threshold</div>
                <div class="text-2xl font-bold text-red-400">${selGauge.inverted ? '<' : '>'} ${formatValue(selGauge.warn, selGauge)}</div>
              </div>
            </div>

            ${selData?.reasoning ? `
              <div class="bg-indigo-500/10 border border-indigo-500/30 rounded-lg p-4 mb-4">
                <div class="text-indigo-400 font-semibold mb-2">ü§ñ Claude's Analysis</div>
                <p class="text-slate-300 text-sm">${selData.reasoning}</p>
                ${selData.signals ? `<div class="mt-2 flex flex-wrap gap-2">${selData.signals.map(s => `<span class="px-2 py-1 bg-indigo-500/20 rounded text-xs text-indigo-300">${s}</span>`).join('')}</div>` : ''}
              </div>
            ` : ''}

            <div class="space-y-4 text-sm">
              <div><h3 class="text-cyan-400 font-semibold mb-1">What It Measures</h3><p class="text-slate-300">${selGauge.meaning}</p></div>
              <div><h3 class="text-cyan-400 font-semibold mb-1">How It's Calculated</h3><p class="text-slate-300">${selGauge.calculation}</p></div>
              <div><h3 class="text-cyan-400 font-semibold mb-1">Why It Matters</h3><p class="text-slate-300">${selGauge.whyItMatters}</p></div>
              <div><h3 class="text-cyan-400 font-semibold mb-1">Thresholds</h3><p class="text-slate-300">${selGauge.thresholds}</p></div>
            </div>
          </div>
        ` : ''}

        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-8">
          ${GAUGES.map(g => {
            const d = gaugeData[g.key];
            const level = d ? getRiskLevel(d.value, g) : 'safe';
            const colors = {
              safe: { bg: 'rgba(16,185,129,0.1)', border: 'rgba(16,185,129,0.3)', text: '#10b981' },
              warning: { bg: 'rgba(245,158,11,0.1)', border: 'rgba(245,158,11,0.3)', text: '#f59e0b' },
              danger: { bg: 'rgba(239,68,68,0.1)', border: 'rgba(239,68,68,0.3)', text: '#ef4444' }
            }[level];
            const isSelected = selectedGauge === g.key;
            const opacity = d?.quality === 'FALLBACK' ? 'opacity-70' : '';
            
            return `
              <div onclick="selectGauge('${g.key}')" class="p-4 rounded-xl cursor-pointer hover:scale-105 transition-all ${isSelected ? 'ring-2 ring-cyan-500' : ''} ${opacity}" style="background: ${colors.bg}; border: 1px solid ${colors.border};">
                <div class="flex justify-between items-start mb-1">
                  <div class="text-xs text-slate-500 uppercase">${g.category}</div>
                  ${getQualityBadge(d?.quality)}
                </div>
                <div class="text-sm font-semibold text-slate-200 mb-3">${g.name}</div>
                <div class="text-2xl font-bold mb-1" style="color: ${colors.text}">${formatValue(d?.value, g)}</div>
                <div class="text-xs text-slate-500 truncate">${d?.source || 'No data'}</div>
              </div>`;
          }).join('')}
        </div>

        <div class="bg-slate-800/50 rounded-xl p-6 mb-8">
          <h2 class="text-lg font-bold mb-4">Risk Framework</h2>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
            <div class="p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/30"><div class="font-semibold text-emerald-400">NORMAL</div><div class="text-slate-400">0-1 danger</div></div>
            <div class="p-3 rounded-lg bg-amber-500/10 border border-amber-500/30"><div class="font-semibold text-amber-400">CAUTION</div><div class="text-slate-400">1 danger OR 5+ warnings</div></div>
            <div class="p-3 rounded-lg bg-orange-500/10 border border-orange-500/30"><div class="font-semibold text-orange-400">OVERHEATING</div><div class="text-slate-400">2-3 danger</div></div>
            <div class="p-3 rounded-lg bg-red-500/10 border border-red-500/30"><div class="font-semibold text-red-400">BUBBLE</div><div class="text-slate-400">4+ danger</div></div>
          </div>
        </div>

        <div class="bg-slate-800/30 rounded-xl p-4 mb-8">
          <div class="flex items-center gap-2 mb-2">
            <span class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></span><span class="text-xs text-slate-400">Live = Real-time API</span>
            <span class="w-2 h-2 bg-amber-400 rounded-full ml-4"></span><span class="text-xs text-slate-400">Delayed = Lagged data</span>
            <span class="w-2 h-2 bg-slate-500 rounded-full ml-4"></span><span class="text-xs text-slate-400">Est. = Estimate (click Refresh or Analyze)</span>
          </div>
        </div>

        <div class="text-center text-slate-600 text-xs">Based on Exponential View framework ‚Ä¢ Not investment advice</div>
      `;
    }

    fetchAllData();
  </script>
</body>
</html>
